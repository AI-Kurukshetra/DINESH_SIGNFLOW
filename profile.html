<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignFlow - User Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-pen-nib"></i>
                <span>SignFlow</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html">Dashboard</a>
                <a href="profile.html" class="active">Profile</a>
                <a href="#" onclick="logOutUser()">Logout</a>
            </div>
            <div class="nav-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>

    <!-- Profile Section -->
    <div class="container" style="padding: 40px 20px; max-width: 800px;">
        <!-- Tab Navigation -->
        <div class="profile-tabs">
            <button class="tab-btn active" onclick="switchTab('profile')">
                <i class="fas fa-user"></i> Profile
            </button>
            <button class="tab-btn" onclick="switchTab('security')">
                <i class="fas fa-lock"></i> Security
            </button>
            <button class="tab-btn" onclick="switchTab('activity')">
                <i class="fas fa-history"></i> Activity
            </button>
            <button class="tab-btn" onclick="switchTab('preferences')">
                <i class="fas fa-cog"></i> Preferences
            </button>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content active">
            <div class="profile-card">
                <h2>Personal Information</h2>
                
                <!-- Error/Success Messages -->
                <div id="profile-error" class="auth-error" style="display: none;"></div>
                <div id="profile-success" class="auth-success" style="display: none;"></div>

                <div class="profile-avatar">
                    <img id="avatar-image" src="" alt="Profile Picture" onerror="setDefaultAvatar()">
                    <button class="btn-edit-avatar" onclick="changeAvatar()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>

                <form id="profile-form" class="auth-email-form">
                    <div class="form-group">
                        <label for="prof-name">Full Name</label>
                        <input type="text" id="prof-name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="prof-email">Email Address</label>
                        <input type="email" id="prof-email" name="email" readonly>
                        <small style="color: #999; margin-top: 4px;">Email cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label for="prof-company">Company</label>
                        <input type="text" id="prof-company" name="company" placeholder="Your company name">
                    </div>

                    <div class="form-group">
                        <label for="prof-position">Position</label>
                        <input type="text" id="prof-position" name="position" placeholder="Your job title">
                    </div>

                    <div class="form-group">
                        <label for="prof-phone">Phone Number</label>
                        <input type="tel" id="prof-phone" name="phone" placeholder="+1 (555) 000-0000">
                    </div>

                    <button type="submit" class="btn-primary">Update Profile</button>
                </form>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="security-tab" class="tab-content">
            <div class="profile-card">
                <h2>Security Settings</h2>

                <!-- Error/Success Messages -->
                <div id="security-error" class="auth-error" style="display: none;"></div>
                <div id="security-success" class="auth-success" style="display: none;"></div>

                <!-- Change Password Section -->
                <div class="security-section">
                    <h3>Change Password</h3>
                    <form id="password-form" class="auth-email-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" name="currentPassword" required>
                        </div>

                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input 
                                type="password" 
                                id="new-password" 
                                name="newPassword" 
                                required
                                onkeyup="updatePasswordStrength(event)"
                            >
                            <div class="password-strength">
                                <div>
                                    <div class="password-strength-bar" id="sec-strength-bar"></div>
                                </div>
                                <div class="password-strength-text" id="sec-strength-text">Password strength: Weak</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirm-new-password">Confirm New Password</label>
                            <input type="password" id="confirm-new-password" name="confirmNewPassword" required>
                        </div>

                        <button type="submit" class="btn-primary">Update Password</button>
                    </form>
                </div>

                <!-- Two-Factor Authentication -->
                <div class="security-section" style="border-top: 1px solid #eee; padding-top: 24px; margin-top: 24px;">
                    <h3>Two-Factor Authentication</h3>
                    <p>Add an extra layer of security to your account</p>
                    <div id="2fa-status" style="margin: 16px 0; padding: 12px; background: #f0f0f0; border-radius: 6px;">
                        Status: <strong>Not Enabled</strong>
                    </div>
                    <button class="btn-primary" onclick="enable2FA()">Enable 2FA</button>
                </div>

                <!-- Active Sessions -->
                <div class="security-section" style="border-top: 1px solid #eee; padding-top: 24px; margin-top: 24px;">
                    <h3>Active Sessions</h3>
                    <div id="sessions-list">
                        <div class="session-item">
                            <div>
                                <strong>Current Session</strong>
                                <p class="session-info">Last active: Just now</p>
                            </div>
                            <small>Current device</small>
                        </div>
                    </div>
                </div>

                <!-- Logout All Devices -->
                <div style="margin-top: 20px;">
                    <button class="btn-danger" onclick="logoutAllDevices()">Logout All Devices</button>
                </div>
            </div>
        </div>

        <!-- Activity Tab -->
        <div id="activity-tab" class="tab-content">
            <div class="profile-card">
                <h2>Login Activity</h2>
                <div id="activity-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Activity items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Preferences Tab -->
        <div id="preferences-tab" class="tab-content">
            <div class="profile-card">
                <h2>Preferences</h2>

                <!-- Error/Success Messages -->
                <div id="pref-error" class="auth-error" style="display: none;"></div>
                <div id="pref-success" class="auth-success" style="display: none;"></div>

                <form id="preferences-form" class="auth-email-form">
                    <div class="form-group">
                        <label>Email Notifications</label>
                        <div class="checkbox-group">
                            <div class="form-remember">
                                <input type="checkbox" id="notif-documents" name="notifDocuments" checked>
                                <label for="notif-documents">Document shared with me</label>
                            </div>
                            <div class="form-remember">
                                <input type="checkbox" id="notif-signature" name="notifSignature" checked>
                                <label for="notif-signature">Signature requests</label>
                            </div>
                            <div class="form-remember">
                                <input type="checkbox" id="notif-updates" name="notifUpdates">
                                <label for="notif-updates">Product updates & news</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label for="theme">Theme</label>
                        <select id="theme" name="theme" style="padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Inter', sans-serif;">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="auto">Auto (system default)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label for="language">Language</label>
                        <select id="language" name="language" style="padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Inter', sans-serif;">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-primary" style="margin-top: 24px;">Save Preferences</button>
                </form>

                <!-- Danger Zone -->
                <div class="danger-zone" style="margin-top: 40px; padding: 20px; background: #fff3f3; border: 1px solid #ffebee; border-radius: 6px;">
                    <h3 style="color: #d32f2f; margin-top: 0;">Danger Zone</h3>
                    <p>Irreversible actions</p>
                    <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
                    <small style="display: block; margin-top: 8px; color: #666;">This will permanently delete your account and all associated data.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Styled CSS for Profile -->
    <style>
        .profile-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profile-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-card h2 {
            margin-top: 0;
            color: #1a1a1a;
        }

        .profile-card h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 24px;
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #f0f0f0;
        }

        .btn-edit-avatar {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .security-section {
            margin-bottom: 24px;
        }

        .security-section p {
            color: #666;
            margin: 8px 0;
        }

        .session-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-info {
            font-size: 13px;
            color: #999;
            margin: 4px 0 0 0;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-danger {
            padding: 10px 16px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .danger-zone {
            margin-top: 24px;
        }

        .danger-zone h3 {
            margin: 0 0 8px 0;
        }
    </style>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/userManager.js"></script>
    <script src="js/storage.js"></script>

    <script>
        // Require authentication
        requireAuth();

        // Load user profile on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
        });

        // Function to load user profile
        function loadUserProfile() {
            const user = UserManager.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Populate profile form
            document.getElementById('prof-name').value = user.name || '';
            document.getElementById('prof-email').value = user.email || '';
            document.getElementById('prof-company').value = user.metadata?.company || '';
            document.getElementById('prof-position').value = user.metadata?.position || '';
            document.getElementById('prof-phone').value = user.metadata?.phoneNumber || '';

            // Load avatar
            if (user.picture) {
                document.getElementById('avatar-image').src = user.picture;
            } else {
                setDefaultAvatar();
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.closest('.tab-btn').classList.add('active');
        }

        // Handle profile update
        document.getElementById('profile-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const user = UserManager.getCurrentUser();
            const updates = {
                name: document.getElementById('prof-name').value,
                metadata: {
                    ...user.metadata,
                    company: document.getElementById('prof-company').value,
                    position: document.getElementById('prof-position').value,
                    phoneNumber: document.getElementById('prof-phone').value
                }
            };

            try {
                UserManager.updateUser(user.id, updates);
                showProfileSuccess('Profile updated successfully');
                loadUserProfile();
            } catch (error) {
                showProfileError(error.message);
            }
        });

        // Handle password change
        document.getElementById('password-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const user = UserManager.getCurrentUser();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;

            // Validation
            if (newPassword !== confirmNewPassword) {
                showSecurityError('New passwords do not match');
                return;
            }

            if (newPassword.length < 8) {
                showSecurityError('Password must be at least 8 characters');
                return;
            }

            try {
                UserManager.updatePassword(user.id, currentPassword, newPassword);
                showSecuritySuccess('Password updated successfully');
                document.getElementById('password-form').reset();
            } catch (error) {
                showSecurityError(error.message);
            }
        });

        // Handle preferences update
        document.getElementById('preferences-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const user = UserManager.getCurrentUser();
            const updates = {
                metadata: {
                    ...user.metadata,
                    emailNotifications: {
                        documents: document.getElementById('notif-documents').checked,
                        signature: document.getElementById('notif-signature').checked,
                        updates: document.getElementById('notif-updates').checked
                    }
                }
            };

            try {
                UserManager.updateUser(user.id, updates);
                showPrefSuccess('Preferences saved successfully');
            } catch (error) {
                showPrefError(error.message);
            }
        });

        // Logout user
        function logOutUser() {
            if (confirm('Are you sure you want to log out?')) {
                AuthModule.signOut();
            }
        }

        // Change avatar
        function changeAvatar() {
            alert('Avatar upload functionality coming soon');
        }

        // Set default avatar
        function setDefaultAvatar() {
            const user = UserManager.getCurrentUser();
            const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // Random background color
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];
            ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
            ctx.fillRect(0, 0, 100, 100);
            
            // Text
            ctx.font = 'bold 40px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, 50, 50);
            
            document.getElementById('avatar-image').src = canvas.toDataURL();
        }

        // Update password strength for security tab
        function updatePasswordStrength(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('sec-strength-bar');
            const strengthText = document.getElementById('sec-strength-text');

            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            strengthBar.className = 'password-strength-bar';
            if (strength <= 2) {
                strengthBar.classList.add('weak');
                strengthText.textContent = 'Password strength: Weak';
            } else if (strength <= 3) {
                strengthBar.classList.add('medium');
                strengthText.textContent = 'Password strength: Medium';
            } else {
                strengthBar.classList.add('strong');
                strengthText.textContent = 'Password strength: Strong';
            }
        }

        // Show/hide messages
        function showProfileError(msg) {
            document.getElementById('profile-error').textContent = msg;
            document.getElementById('profile-error').style.display = 'block';
        }

        function showProfileSuccess(msg) {
            document.getElementById('profile-success').textContent = msg;
            document.getElementById('profile-success').style.display = 'block';
            setTimeout(() => {
                document.getElementById('profile-success').style.display = 'none';
            }, 3000);
        }

        function showSecurityError(msg) {
            document.getElementById('security-error').textContent = msg;
            document.getElementById('security-error').style.display = 'block';
        }

        function showSecuritySuccess(msg) {
            document.getElementById('security-success').textContent = msg;
            document.getElementById('security-success').style.display = 'block';
            setTimeout(() => {
                document.getElementById('security-success').style.display = 'none';
            }, 3000);
        }

        function showPrefError(msg) {
            document.getElementById('pref-error').textContent = msg;
            document.getElementById('pref-error').style.display = 'block';
        }

        function showPrefSuccess(msg) {
            document.getElementById('pref-success').textContent = msg;
            document.getElementById('pref-success').style.display = 'block';
            setTimeout(() => {
                document.getElementById('pref-success').style.display = 'none';
            }, 3000);
        }

        // Additional functions
        function enable2FA() {
            alert('Two-factor authentication setup will be available soon');
        }

        function logoutAllDevices() {
            if (confirm('This will logout your account from all devices. Continue?')) {
                alert('All devices have been logged out');
                AuthModule.signOut();
            }
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                const password = prompt('Please enter your password to confirm account deletion:');
                if (password) {
                    try {
                        const user = UserManager.getCurrentUser();
                        UserManager.deleteUser(user.id);
                        alert('Account deleted successfully');
                        window.location.href = 'login.html';
                    } catch (error) {
                        alert('Error deleting account: ' + error.message);
                    }
                }
            }
        }
    </script>
</body>
</html>
